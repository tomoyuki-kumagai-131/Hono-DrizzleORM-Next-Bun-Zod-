# OAuth 同意画面の詳細設定ガイド

## ステップ 1: OAuth 同意画面にアクセス

1. [Google Cloud Console](https://console.cloud.google.com/) を開く
2. 上部のプロジェクト選択ドロップダウンから、あなたのプロジェクトを選択
3. 左側のナビゲーションメニュー（☰）をクリック
4. **「API とサービス」** にカーソルを合わせる
5. サブメニューから **「OAuth 同意画面」** をクリック

---

## ステップ 2: User Type（ユーザータイプ）の選択

初めて設定する場合、User Type を選択する画面が表示されます。

### オプション 1: 内部（Internal）
- Google Workspace 組織内のユーザーのみアクセス可能
- 個人用 Gmail アカウントの場合は選択不可

### オプション 2: 外部（External）⭐ おすすめ
- 誰でもアクセス可能
- 開発・テスト段階では「テストユーザー」を追加する必要あり
- **個人開発の場合はこちらを選択**

**選択方法:**
1. **「外部」** を選択
2. **「作成」** ボタンをクリック

---

## ステップ 3: アプリ情報の入力

### 3-1. アプリ情報セクション

**必須フィールド:**

1. **アプリ名**
   ```
   Twitter Clone
   ```
   または任意のアプリ名

2. **ユーザーサポートメール**
   - ドロップダウンから自分のメールアドレスを選択
   ```
   tmyk.engineer@gmail.com
   ```

3. **アプリのロゴ**（オプション）
   - スキップ可能

### 3-2. アプリのドメインセクション（オプション）

開発段階では空欄でOK。以下は省略可能:
- アプリのホームページ
- アプリのプライバシー ポリシーのリンク
- アプリの利用規約のリンク

### 3-3. 承認済みドメイン（オプション）

開発段階では空欄でOK。

### 3-4. デベロッパーの連絡先情報

**必須:**
```
tmyk.engineer@gmail.com
```

**完了したら:**
- **「保存して次へ」** ボタンをクリック

---

## ステップ 4: スコープ（Scopes）の設定

スコープは、アプリがアクセスできるユーザー情報を定義します。

### デフォルトのスコープ（自動的に含まれる）:
- `openid`
- `email`
- `profile`

これらで十分なので:
1. 何も変更せず **「保存して次へ」** をクリック

### もし追加情報が必要な場合:
1. **「スコープを追加または削除」** ボタンをクリック
2. 必要なスコープを選択
   - `/auth/userinfo.email` - メールアドレス
   - `/auth/userinfo.profile` - 基本プロフィール情報
3. **「更新」** をクリック

---

## ステップ 5: テストユーザーの追加 ⚠️ 重要

**外部（External）を選択した場合、このステップは必須です！**

### なぜテストユーザーが必要？
- アプリが「公開」ステータスになるまで、テストユーザーのみがアプリにアクセス可能
- テストユーザーに登録されていないアカウントでログインしようとするとエラーになる

### テストユーザーの追加方法:

1. **「テストユーザー」** セクションで **「+ ADD USERS」** ボタンをクリック

2. ポップアップが表示されるので、メールアドレスを入力:
   ```
   tmyk.engineer@gmail.com
   ```

3. 複数のメールアドレスを追加する場合は、Enter キーで区切る
   ```
   tmyk.engineer@gmail.com
   another.email@gmail.com
   test.user@gmail.com
   ```

4. **「追加」** ボタンをクリック

5. テストユーザーが一覧に表示されることを確認

6. **「保存して次へ」** をクリック

---

## ステップ 6: 概要の確認

1. 入力した情報を確認
2. 問題なければ **「ダッシュボードに戻る」** をクリック

---

## ステップ 7: 公開ステータスの確認

ダッシュボードに戻ると、以下の情報が表示されます:

### 公開ステータス:
- **テスト中** - 最大100人のテストユーザーのみアクセス可能
- **本番環境** - 誰でもアクセス可能（審査が必要）

### 開発中は「テスト中」で十分です

---

## トラブルシューティング

### エラー: "Access blocked: This app's request is invalid"

**原因:** テストユーザーが追加されていない

**解決策:**
1. OAuth 同意画面に戻る
2. 「テストユーザー」セクションを確認
3. `tmyk.engineer@gmail.com` が追加されているか確認
4. 追加されていなければ、ステップ5 を実行

### エラー: "This app is blocked"

**原因:** OAuth 同意画面が完了していない

**解決策:**
1. OAuth 同意画面のすべてのステップを完了
2. 「保存して次へ」を各ステップでクリック
3. 最後まで完了させる

### 別のアカウントでテストしたい場合

1. OAuth 同意画面 → テストユーザー
2. **「+ ADD USERS」** をクリック
3. 新しいメールアドレスを追加
4. **「保存」** をクリック

---

## チェックリスト

設定が完了したら、以下を確認してください:

- [ ] User Type で「外部」を選択した
- [ ] アプリ名を入力した
- [ ] ユーザーサポートメールを設定した
- [ ] デベロッパーの連絡先を設定した
- [ ] スコープのページで「保存して次へ」をクリックした
- [ ] **テストユーザーに `tmyk.engineer@gmail.com` を追加した** ⭐
- [ ] 「ダッシュボードに戻る」をクリックした
- [ ] 公開ステータスが「テスト中」になっている

---

## 次のステップ

OAuth 同意画面の設定が完了したら:

1. **OAuth クライアント ID** の設定を確認
   - 「認証情報」ページに移動
   - 承認済み JavaScript 生成元を確認
   - 承認済みリダイレクト URI を確認

2. **フロントエンドサーバーを再起動**
   ```bash
   cd frontend
   npm run dev
   ```

3. **アプリをテスト**
   - http://localhost:3000/login にアクセス
   - Google Sign-In ボタンをクリック
   - `tmyk.engineer@gmail.com` でログイン

---

## 画面の遷移フロー

```
Google Cloud Console
  ↓
API とサービス
  ↓
OAuth 同意画面
  ↓
[1] User Type 選択（外部を選択）
  ↓
[2] アプリ情報入力
  ↓
[3] スコープ設定（デフォルトのまま）
  ↓
[4] テストユーザー追加 ← ⭐ ここが重要！
  ↓
[5] 概要確認
  ↓
ダッシュボードに戻る
```

---

## よくある質問

### Q: テストユーザーは何人まで追加できる？
A: 最大100人まで追加可能です。

### Q: テストユーザーを追加しないとどうなる？
A: アプリが「テスト中」の状態で、テストユーザー以外がログインしようとすると「Access blocked」エラーが表示されます。

### Q: アプリを本番環境に公開する必要はある？
A: 開発・個人利用の場合は不要です。「テスト中」のまま使用できます。

### Q: 本番環境に公開するには？
A: Google の審査が必要です。OAuth 同意画面ページの「アプリを公開」ボタンから申請できます。

### Q: Gmail 以外のアカウントも使える？
A: はい。Google アカウント（Gmail、Workspace など）であれば使用可能です。
